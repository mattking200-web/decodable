<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Decodable Reading Builder</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f8ff;
  text-align: center;
  padding: 20px;
}

#picture {
  font-size: 100px;
  margin: 20px;
}

#story {
  font-size: 28px;
  margin: 25px;
  line-height: 1.6;
}

.word { padding: 4px; }

.missed {
  color: red;
  cursor: pointer;
  font-weight: bold;
  text-decoration: underline;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  margin: 10px;
}

#heard {
  margin-top: 15px;
  font-size: 18px;
}

#status {
  font-weight: bold;
  margin-top: 10px;
}
</style>
</head>
<body>

<h1>Decodable Story Practice</h1>

<div id="picture"></div>
<div id="story"></div>

<button onclick="startListening()">ðŸŽ¤ Start Reading</button>
<button onclick="newStory()">ðŸ“– Next Story</button>

<div id="status"></div>
<div id="heard"></div>

<script>

// ---------------- WORD BANKS ----------------

const nouns = ["cat","dog","pig","bug","sun"];
const verbs = ["run","hop","dig","sit","nap"];
const places = ["mat","box","mud","rug","hill"];

let missed = { noun:null, verb:null, place:null };
let current = { noun:null, verb:null, place:null };
let storyWords = [];

// ---------------- STORY ----------------

function generateStory() {

  current.noun = missed.noun || random(nouns);
  current.verb = missed.verb || random(verbs);
  current.place = missed.place || random(places);

  missed = { noun:null, verb:null, place:null };

  let sentence1 = ["the", current.noun, "can", current.verb];
  let sentence2 = ["the", current.noun, "is", "on", "the", current.place];

  storyWords = [...sentence1, ...sentence2];

  renderStory(sentence1, sentence2);
}

function renderStory(s1, s2) {

  const storyDiv = document.getElementById("story");
  storyDiv.innerHTML = "";

  let formatted =
    capitalize(s1.join(" ")) + ". " +
    capitalize(s2.join(" ")) + ".";

  let split = formatted.replace(/[.]/g,"").toLowerCase().split(" ");

  split.forEach((word, index) => {
    let span = document.createElement("span");
    span.innerText = word + " ";
    span.classList.add("word");
    span.id = "word-" + index;
    storyDiv.appendChild(span);

    if (index === s1.length - 1) {
      storyDiv.appendChild(document.createTextNode(". "));
    }
  });

  storyDiv.appendChild(document.createTextNode("."));
}

function capitalize(text) {
  return text.charAt(0).toUpperCase() + text.slice(1);
}

function random(arr) {
  return arr[Math.floor(Math.random()*arr.length)];
}

// ---------------- SPEECH ----------------

function startListening() {

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Use Chrome for best speech detection.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  document.getElementById("status").innerText = "Listening...";
  recognition.start();

  recognition.onresult = function(event) {
    let spoken = event.results[0][0].transcript;
    document.getElementById("status").innerText = "Processing...";
    processSpeech(spoken);
  };

  recognition.onend = function() {
    document.getElementById("status").innerText = "Done.";
  };
}

// ---------------- PROCESS + SCORE ----------------

function processSpeech(text) {

  text = text.toLowerCase().replace(/[.]/g,"").trim();
  let spokenWords = text.split(/\s+/);

  // Display formatted speech
  let firstLen = 4;
  let secondLen = 6;

  let s1 = spokenWords.slice(0, firstLen).join(" ");
  let s2 = spokenWords.slice(firstLen, firstLen+secondLen).join(" ");

  document.getElementById("heard").innerText =
    capitalize(s1) + ". " + capitalize(s2) + ".";

  score(spokenWords);
}

function score(spokenWords) {

  storyWords.forEach((word, index) => {

    if (word.length === 3) {

      let span = document.getElementById("word-" + index);
      let spokenWord = spokenWords[index] || "";

      if (spokenWord !== word) {

        span.classList.add("missed");
        span.onclick = function() {
          spellWord(word);
        };

        if (nouns.includes(word)) missed.noun = word;
        if (verbs.includes(word)) missed.verb = word;
        if (places.includes(word)) missed.place = word;

      } else {
        span.classList.remove("missed");
        span.onclick = null;
      }
    }
  });
}

// ---------------- SPELL ----------------

function spellWord(word) {
  let letters = word.split("").join(" - ");
  let utter = new SpeechSynthesisUtterance(letters + "... " + word);
  utter.rate = 0.8;
  speechSynthesis.speak(utter);
}

// ---------------- NEXT STORY ----------------

function newStory() {
  generateStory();
}

generateStory();

</script>
</body>
</html>

