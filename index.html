<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Decodable Reading Builder</title>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
  background: #f4f8fb;
}

#story {
  font-size: 30px;
  margin: 20px;
  line-height: 1.6;
}

.word {
  cursor: pointer;
  padding: 4px;
}

.incorrect {
  color: red;
  font-weight: bold;
}

button {
  padding: 10px 20px;
  font-size: 18px;
  margin: 10px;
  cursor: pointer;
}

#feedback {
  font-size: 20px;
  margin-top: 15px;
}
</style>
</head>

<body>

<h1>Decodable Reading Practice</h1>

<div id="story"></div>

<button onclick="startReading()">Start Reading</button>
<button onclick="stopReading()">Stop</button>
<button onclick="newStory()">New Story</button>

<div id="feedback"></div>

<script>

let recognition;
let displayWords = [];  // With capitalization
let scoringWords = [];  // Lowercase only
let missedWords = [];

// Word banks
const nouns = ["cat","dog","sun","hat","box"];
const verbs = ["run","sit","dig"];
const prepositions = ["on","in"];

// Build structured sentences
function buildStory() {

  let noun1 = nouns[Math.floor(Math.random()*nouns.length)];
  let noun2 = nouns[Math.floor(Math.random()*nouns.length)];
  let verb = verbs[Math.floor(Math.random()*verbs.length)];
  let prep = prepositions[Math.floor(Math.random()*prepositions.length)];

  // If student missed a word, force it in
  if(missedWords.length > 0){
    noun1 = missedWords[0];
  }

  // Sentence 1
  const sentence1 = ["The", noun1, "can", verb + "."];
  const sentence2 = ["The", noun2, "is", prep, "the", noun1 + "."];

  displayWords = [...sentence1, ...sentence2];

  // Lowercase clean scoring version
  scoringWords = displayWords
    .join(" ")
    .toLowerCase()
    .replace(/[^\w\s]/g,"")
    .split(" ");
}

// Render story
function renderStory(){

  const storyDiv = document.getElementById("story");
  storyDiv.innerHTML = "";

  displayWords.forEach(word => {

    const cleanWord = word.replace(".", "");

    const span = document.createElement("span");
    span.classList.add("word");
    span.innerText = word + " ";
    span.onclick = () => spellWord(cleanWord);

    storyDiv.appendChild(span);
  });
}

function spellWord(word){

  speechSynthesis.cancel();

  const utter = new SpeechSynthesisUtterance(
    word.split("").join(" ") + ". " + word
  );

  speechSynthesis.speak(utter);
}

function newStory(){
  buildStory();
  renderStory();
  document.getElementById("feedback").innerText = "";
}

function startReading(){

  if(!('webkitSpeechRecognition' in window)){
    alert("Use Chrome browser.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  recognition.onresult = function(event){
    const transcript =
      event.results[event.results.length-1][0].transcript;

    compareReading(transcript);
  };

  recognition.start();
  document.getElementById("feedback").innerText = "Listening...";
}

function stopReading(){
  if(recognition) recognition.stop();
}

function compareReading(spokenText){

  const spoken = spokenText
    .toLowerCase()
    .replace(/[^\w\s]/g,"")
    .split(/\s+/)
    .filter(Boolean);

  let storyIndex = 0;
  missedWords = [];

  for(let i=0; i<spoken.length && storyIndex<scoringWords.length; i++){

    if(spoken[i] === scoringWords[storyIndex]){
      storyIndex++;
    }
  }

  if(storyIndex === scoringWords.length){
    document.getElementById("feedback").innerText =
      "Great reading!";
  } else {

    missedWords = scoringWords.slice(storyIndex);
    highlightMissed(storyIndex);

    document.getElementById("feedback").innerText =
      "Click red words to hear them.";
  }
}

function highlightMissed(startIndex){

  const spans = document.querySelectorAll(".word");

  for(let i=startIndex; i<spans.length; i++){
    spans[i].classList.add("incorrect");
  }
}

newStory();

</script>

</body>
</html>
