<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Decodable Reading Builder</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f8ff;
  text-align: center;
  padding: 20px;
}

h1 {
  margin-bottom: 10px;
}

#picture {
  font-size: 100px;
  margin: 20px;
}

#story {
  font-size: 28px;
  margin: 25px;
  line-height: 1.6;
}

.word {
  padding: 4px;
}

.missed {
  color: red;
  cursor: pointer;
  font-weight: bold;
  text-decoration: underline;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  margin: 10px;
}

#status {
  margin-top: 10px;
  font-weight: bold;
}

#heard {
  margin-top: 10px;
  font-size: 18px;
}
</style>
</head>
<body>

<h1>Decodable Story Practice</h1>

<div id="picture"></div>
<div id="story"></div>

<button onclick="startListening()">ðŸŽ¤ Start Reading</button>
<button onclick="newStory()">ðŸ“– Next Story</button>

<div id="status"></div>
<div id="heard"></div>

<script>

// ---------------- WORD BANKS ----------------

const nouns = [
  {word:"cat", emoji:"ðŸ±"},
  {word:"dog", emoji:"ðŸ¶"},
  {word:"pig", emoji:"ðŸ·"},
  {word:"bug", emoji:"ðŸž"},
  {word:"sun", emoji:"â˜€ï¸"}
];

const verbs = ["run","hop","dig","sit","nap"];
const places = ["mat","box","mud","rug","hill"];

let missedWords = [];
let currentWords = [];
let currentStoryStructure = null;

// ---------------- STORY GENERATION ----------------

function generateStory() {

  let noun = nouns[Math.floor(Math.random()*nouns.length)];
  let verb = verbs[Math.floor(Math.random()*verbs.length)];
  let place = places[Math.floor(Math.random()*places.length)];

  // Inject previously missed words if available
  if (missedWords.length > 0) {
    noun.word = missedWords[0];
  }

  let sentence1 = ["the", noun.word, "can", verb];
  let sentence2 = ["the", noun.word, "is", "on", "the", place];

  currentStoryStructure = [sentence1, sentence2];

  currentWords = [...sentence1, ...sentence2];

  document.getElementById("picture").innerText = noun.emoji;

  renderStory();
  document.getElementById("heard").innerText = "";
}

function renderStory() {

  const storyDiv = document.getElementById("story");
  storyDiv.innerHTML = "";

  currentWords.forEach((word, index) => {

    let span = document.createElement("span");
    span.innerText = word + " ";
    span.classList.add("word");
    span.id = "word-" + index;

    storyDiv.appendChild(span);

    // Add period after sentence 1
    if (index === currentStoryStructure[0].length - 1) {
      storyDiv.appendChild(document.createTextNode(". "));
    }
  });

  storyDiv.appendChild(document.createTextNode("."));
}

// ---------------- SPEECH RECOGNITION ----------------

function startListening() {

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Please use Google Chrome for speech recognition.");
    return;
  }

  const recognition = new SpeechRecognition();

  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  document.getElementById("status").innerText = "ðŸŽ¤ Listening...";
  recognition.start();

  recognition.onresult = function(event) {

    let spoken = event.results[0][0].transcript.toLowerCase();
    document.getElementById("status").innerText = "Processing...";

    processSpeech(spoken);
  };

  recognition.onerror = function(event) {
    document.getElementById("status").innerText = "Error: " + event.error;
  };

  recognition.onend = function() {
    document.getElementById("status").innerText = "Finished.";
  };
}

// ---------------- PROCESS + FORMAT + SCORE ----------------

function processSpeech(spokenText) {

  spokenText = spokenText.replace(/[.]/g,"").trim();
  let spokenWords = spokenText.split(/\s+/);

  let formatted = formatToStory(spokenWords);
  document.getElementById("heard").innerText = formatted;

  scoreReading(spokenWords);
}

function formatToStory(spokenWords) {

  let pointer = 0;

  let first = spokenWords.slice(pointer, pointer + currentStoryStructure[0].length).join(" ");
  pointer += currentStoryStructure[0].length;

  let second = spokenWords.slice(pointer, pointer + currentStoryStructure[1].length).join(" ");

  function cap(s) {
    if (!s) return "";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  return cap(first) + ". " + cap(second) + ".";
}

function scoreReading(spokenWords) {

  missedWords = [];

  currentWords.forEach((word, index) => {

    if (word.length === 3) { // only CVC

      let span = document.getElementById("word-" + index);
      let spokenWord = spokenWords[index] || "";

      if (spokenWord !== word) {

        span.classList.add("missed");
        span.onclick = function() {
          spellWord(word);
        };

        if (!missedWords.includes(word)) {
          missedWords.push(word);
        }

      } else {
        span.classList.remove("missed");
        span.onclick = null;
      }
    }
  });
}

// ---------------- SPELL WORD ----------------

function spellWord(word) {

  let letters = word.split("").join(" - ");
  let utter = new SpeechSynthesisUtterance(letters + "... " + word);
  utter.rate = 0.8;
  speechSynthesis.speak(utter);
}

// ---------------- NEXT STORY ----------------

function newStory() {
  generateStory();
}

generateStory();

</script>
</body>
</html>

