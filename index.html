<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Decodable Book Builder</title>
<style>
body { font-family: Arial; text-align: center; background:#f4f8ff; padding:20px; }
#story { font-size: 24px; margin:20px; }
button { padding:10px 20px; margin:10px; font-size:16px; }
img { width:200px; height:200px; margin:10px; }
.correct { color: green; }
.incorrect { color: red; }
</style>
</head>
<body>

<h1>Decodable Story Builder</h1>

<img id="picture" src="">
<div id="story"></div>

<button onclick="startListening()">üé§ Read Story</button>
<button onclick="newStory()">üìñ New Story</button>

<div id="feedback"></div>

<script>

// --- Basic CVC Word List ---
let wordBank = [
"cat","dog","pig","sun","hat","map","pen","cup",
"run","sit","bug","jam","bat","red","box","bed"
];

let missedWords = [];
let currentStoryWords = [];
let recognition;
let currentStoryText = "";

// --- Simple Image Mapping ---
function getImage(word) {
    return "https://dummyimage.com/200x200/cccccc/000000&text=" + word;
}

// --- Generate Story ---
function generateStory() {
    let storyWords = [];

    // Prioritize missed words
    if (missedWords.length > 0) {
        storyWords.push(missedWords[0]);
    }

    while (storyWords.length < 4) {
        storyWords.push(wordBank[Math.floor(Math.random()*wordBank.length)]);
    }

    currentStoryWords = storyWords;
    currentStoryText = `The ${storyWords[0]} can ${storyWords[1]}. The ${storyWords[2]} is on the ${storyWords[3]}.`;

    document.getElementById("story").innerText = currentStoryText;
    document.getElementById("picture").src = getImage(storyWords[0]);
}

generateStory();

// --- Listen to Child ---
function startListening() {

    recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-US";
    recognition.start();

    recognition.onresult = function(event) {
        let spoken = event.results[0][0].transcript.toLowerCase();
        checkReading(spoken);
    };

}

// --- Check Reading ---
function checkReading(spokenText) {

    let spokenWords = spokenText.split(" ");
    let storyWords = currentStoryText.toLowerCase().replace(/[.]/g,"").split(" ");

    let feedbackHTML = "";

    storyWords.forEach(word => {

        if (isDecodable(word)) {

            if (!spokenWords.includes(word)) {

                feedbackHTML += `<div class="incorrect">${word} ‚ùå</div>`;
                missedWords = [word]; // store only latest miss
                soundOut(word);

            } else {
                feedbackHTML += `<div class="correct">${word} ‚úÖ</div>`;
            }

        }
    });

    document.getElementById("feedback").innerHTML = feedbackHTML;
}

// --- Basic CVC Detection ---
function isDecodable(word) {
    return word.length === 3;
}

// --- Sound Out Word ---
function soundOut(word) {
    let letters = word.split("").join(" - ");
    let utter = new SpeechSynthesisUtterance(letters + "... " + word);
    speechSynthesis.speak(utter);
}

// --- New Story ---
function newStory() {
    generateStory();
    document.getElementById("feedback").innerHTML = "";
}

</script>

</body>
</html>
