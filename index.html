<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Decodable Reading Practice</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f7ff;
  text-align: center;
  padding: 20px;
}

#story {
  font-size: 30px;
  margin: 30px;
  line-height: 1.6;
}

.word {
  padding: 4px;
}

.missed {
  color: red;
  cursor: pointer;
  font-weight: bold;
  text-decoration: underline;
}

#picture {
  font-size: 120px;
  margin: 20px;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  margin: 10px;
}
</style>
</head>
<body>

<h1>Decodable Story Practice</h1>

<div id="picture"></div>
<div id="story"></div>

<button onclick="startListening()">ðŸŽ¤ Read Story</button>
<button onclick="newStory()">ðŸ“– Next Story</button>

<script>

// Word banks
const nouns = [
  {word:"cat", emoji:"ðŸ±"},
  {word:"dog", emoji:"ðŸ¶"},
  {word:"pig", emoji:"ðŸ·"},
  {word:"bug", emoji:"ðŸž"},
  {word:"sun", emoji:"â˜€ï¸"},
  {word:"hat", emoji:"ðŸŽ©"},
  {word:"cup", emoji:"â˜•"},
  {word:"bed", emoji:"ðŸ›ï¸"}
];

const verbs = ["run","hop","dig","sit","nap"];
const places = ["mat","box","mud","rug","hill"];

let missedWords = [];
let currentWords = [];
let storyWordsUsed = [];

// Generate Story
function generateStory() {

  let noun = nouns[Math.floor(Math.random()*nouns.length)];
  let verb = verbs[Math.floor(Math.random()*verbs.length)];
  let place = places[Math.floor(Math.random()*places.length)];

  let storyCoreWords = [noun.word, verb, place];

  // Add previously missed words
  let extraWords = [...missedWords];

  storyWordsUsed = [...new Set([...storyCoreWords, ...extraWords])];

  let storyText = `The ${storyWordsUsed[0]} can ${storyWordsUsed[1]}. The ${storyWordsUsed[0]} is on the ${storyWordsUsed[2]}.`;

  if (storyWordsUsed.length > 3) {
    storyText += ` The ${storyWordsUsed[3]} is in the box.`;
  }

  currentWords = storyText.replace(/[.]/g,"").toLowerCase().split(" ");

  document.getElementById("picture").innerText = noun.emoji;
  renderStory(currentWords);
}

// Render story words as clickable spans
function renderStory(words) {

  const storyDiv = document.getElementById("story");
  storyDiv.innerHTML = "";

  words.forEach((word, index) => {

    let span = document.createElement("span");
    span.innerText = word + " ";
    span.classList.add("word");
    span.id = "word-" + index;

    storyDiv.appendChild(span);
  });
}

// Speech recognition
function startListening() {

  const recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  recognition.onresult = function(event) {
    const spoken = event.results[0][0].transcript.toLowerCase();
    checkReading(spoken);
  };
}

// Check reading accuracy
function checkReading(spokenText) {

  const spokenWords = spokenText.split(" ");
  missedWords = [];

  currentWords.forEach((word, index) => {

    // Only check simple CVC words
    if (word.length === 3) {

      let span = document.getElementById("word-" + index);

      if (!spokenWords.includes(word)) {

        span.classList.add("missed");

        span.onclick = function() {
          spellWord(word);
        };

        if (!missedWords.includes(word)) {
          missedWords.push(word);
        }

      } else {
        span.classList.remove("missed");
        span.onclick = null;
      }
    }
  });
}

// Spell word aloud
function spellWord(word) {

  let letters = word.split("").join(" - ");
  let utter = new SpeechSynthesisUtterance(letters + "... " + word);
  utter.rate = 0.8;
  speechSynthesis.speak(utter);
}

// New story
function newStory() {
  generateStory();
}

generateStory();

</script>
</body>
</html>
