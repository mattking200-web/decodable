<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Decodable Reading Builder</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #eef4ff;
  text-align: center;
  padding: 20px;
}

#story {
  font-size: 28px;
  margin: 25px;
}

.word {
  padding: 4px;
}

.missed {
  color: red;
  cursor: pointer;
  font-weight: bold;
  text-decoration: underline;
}

.correct {
  color: green;
}

#picture {
  font-size: 120px;
  margin: 20px;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  margin: 10px;
}
</style>
</head>
<body>

<h1>Decodable Story Practice</h1>

<div id="picture"></div>
<div id="story"></div>

<button onclick="startListening()">ðŸŽ¤ Read Story</button>
<button onclick="newStory()">ðŸ“– New Story</button>

<script>

// Word banks
const nouns = [
  {word:"cat", emoji:"ðŸ±"},
  {word:"dog", emoji:"ðŸ¶"},
  {word:"pig", emoji:"ðŸ·"},
  {word:"bug", emoji:"ðŸž"},
  {word:"sun", emoji:"â˜€ï¸"},
  {word:"hat", emoji:"ðŸŽ©"},
  {word:"cup", emoji:"â˜•"},
  {word:"bed", emoji:"ðŸ›ï¸"}
];

const verbs = ["run","hop","dig","sit","nap"];
const places = ["mat","box","mud","rug","hill"];

let missedWord = null;
let currentWords = [];
let storyText = "";

// Generate Story
function generateStory() {

  let noun = nouns[Math.floor(Math.random()*nouns.length)];
  let verb = verbs[Math.floor(Math.random()*verbs.length)];
  let place = places[Math.floor(Math.random()*places.length)];

  if (missedWord) {
    noun = nouns.find(n => n.word === missedWord) || noun;
  }

  storyText = `The ${noun.word} can ${verb}. The ${noun.word} is on the ${place}.`;
  currentWords = storyText.replace(/[.]/g,"").toLowerCase().split(" ");

  document.getElementById("picture").innerText = noun.emoji;
  renderStory();
}

function renderStory() {

  const storyDiv = document.getElementById("story");
  storyDiv.innerHTML = "";

  currentWords.forEach(word => {

    let span = document.createElement("span");
    span.innerText = word + " ";
    span.classList.add("word");
    span.id = "word-" + word;

    storyDiv.appendChild(span);
  });
}

// Speech recognition
function startListening() {

  const recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.start();

  recognition.onresult = function(event) {
    const spoken = event.results[0][0].transcript.toLowerCase();
    checkReading(spoken);
  };
}

function checkReading(spokenText) {

  const spokenWords = spokenText.split(" ");
  missedWord = null;

  currentWords.forEach(word => {

    // Only check CVC words
    if (word.length === 3) {

      let span = document.getElementById("word-" + word);

      if (!spokenWords.includes(word)) {
        span.classList.add("missed");
        span.onclick = function() {
          spellWord(word);
        };
        missedWord = word;
      } else {
        span.classList.add("correct");
        span.onclick = null;
      }
    }
  });
}

// Spell and say word
function spellWord(word) {

  let letters = word.split("").join(" - ");
  let utter = new SpeechSynthesisUtterance(letters + "... " + word);
  utter.rate = 0.8;
  speechSynthesis.speak(utter);
}

// New story
function newStory() {
  generateStory();
}

generateStory();

</script>

</body>
</html>
